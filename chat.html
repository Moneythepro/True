<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>TrueSocial ‚Äî Chat</title>

  <!-- Lucide icons (single include) -->
  <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/lucide.min.js"></script>

  <!-- Firebase compat (kept as you had) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <style>
    :root{
      --orange:#ff7a00;
      --muted:#666;
      --bg:#ffffff;
      --bubble-shadow: 0 6px 18px rgba(0,0,0,0.04);
      /* safe area support (iOS) */
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-top: env(safe-area-inset-top, 0px);
    }

    /* using calculated vh to avoid mobile chrome resize jumps */
    html,body{
      height:100%;
      margin:0;
      font-family:Inter,system-ui,Roboto,Arial,Helvetica;
      background:var(--bg);
      color:#111;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* container now full-screen using --vh */
    .chat-wrap{
      height: calc(var(--vh, 1vh) * 100);
      display:flex;
      flex-direction:column;
      background:linear-gradient(180deg,#fff,#fff);
      overflow:hidden;
    }

    /* fixed header so keyboard won't push it */
    header{
      display:flex;
      align-items:center;
      gap:12px;
      padding:12px;
      padding-top: calc(12px + var(--safe-top));
      border-bottom:1px solid #f5f5f5;
      background:white;
      position:fixed;
      left:0;
      right:0;
      top:0;
      z-index:40;
      will-change:transform;
    }
    .pfp{width:48px;height:48px;border-radius:12px;background:#f2f2f2;overflow:hidden;display:flex;align-items:center;justify-content:center;flex-shrink:0}
    .pfp img{width:100%;height:100%;object-fit:cover}
    .meta{flex:1;min-width:0}
    .meta .name{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .meta .status{font-size:13px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* messages area ‚Äî account for header and inputBar heights with padding */
    .messages{
      flex:1;
      padding:12px;
      padding-top: calc(12px + 64px); /* header height approx 64 + spacing */
      padding-bottom: calc(120px + var(--safe-bottom)); /* leave space for fixed input */
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      scroll-behavior:smooth;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    /* bubbles */
    .bubble{
      max-width:78%;
      padding:10px;
      border-radius:12px;
      margin-bottom:8px;
      box-shadow: var(--bubble-shadow);
      display:inline-block;
      word-break: break-word; /* wrap long words */
      white-space:pre-wrap;
      line-height:1.35;
      font-size:15px;
    }
    .bubble.sent{
      background: linear-gradient(90deg,#fff,#fff);
      margin-left:auto;
      border-radius:12px 12px 6px 12px;
      text-align:right;
    }
    .bubble.received{
      background:#fff;
      border:1px solid #f6f6f6;
      border-radius:12px 12px 12px 6px;
      text-align:left;
    }
    .metaSmall{font-size:11px;color:#888;margin-top:6px;display:flex;gap:6px;align-items:center;justify-content:flex-end}

    /* fixed input bar at bottom */
    .inputBar{
      position:fixed;
      left:0;
      right:0;
      bottom:0;
      z-index:50;
      display:flex;
      gap:8px;
      padding:10px;
      padding-bottom: calc(10px + var(--safe-bottom));
      border-top:1px solid #f3f3f3;
      background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,1));
      backdrop-filter: blur(6px);
    }
    .input{
      flex:1;
      padding:10px;
      border-radius:12px;
      border:1px solid #f0f0f0;
      display:flex;
      gap:8px;
      align-items:center;
      background:white;
      position:relative;
    }
    .input input{
      border:none;
      outline:none;
      width:100%;
      font-size:15px;
      background:transparent;
    }
    .btn{
      background:var(--orange);
      color:white;
      border:none;
      padding:10px 12px;
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .btn:disabled{opacity:0.5;cursor:not-allowed}

    .tick{font-size:12px;color:#a1a1a1}
    .tick.read{color:green}

    .profile-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.4);z-index:60;padding:12px}
    .profile-modal.open{display:flex}
    .profile-card{background:white;padding:12px;border-radius:12px;width:100%;max-width:420px}

    /* emoji picker placed absolute above input and respects safe area */
    .emoji-picker{
      position:absolute;
      bottom:60px; /* will be adjusted in JS to match input if needed */
      left:8px;
      right:auto;
      padding:10px;
      border-radius:12px;
      background:white;
      box-shadow:0 10px 30px rgba(0,0,0,0.08);
      z-index:120;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      max-width:260px;
    }

    .muted{color:var(--muted);font-size:14px}

    /* landscape tweaks */
    @media (orientation:landscape){
      .messages{max-width:1100px;margin:0 auto}
      .inputBar{max-width:1100px;margin:0 auto;left:0;right:0}
      header{max-width:1100px;margin:0 auto}
    }

    /* small screens */
    @media (max-width:420px){
      .pfp{width:42px;height:42px}
      header{padding:10px;padding-top: calc(10px + var(--safe-top))}
      .message-text{font-size:14px}
    }
  </style>
</head>
<body>
  <div class="chat-wrap">
    <header>
      <div class="pfp" id="chatPfp"><i data-lucide="user"></i></div>
      <div class="meta">
        <div class="name" id="chatName">Contact</div>
        <div class="status" id="chatStatus">Last seen just now</div>
      </div>
      <div style="display:flex;gap:6px;align-items:center">
        <button id="openProfile" style="background:none;border:1px solid #f0f0f0;padding:8px;border-radius:10px"><i data-lucide="user"></i></button>
      </div>
    </header>

    <div id="messages" class="messages" aria-live="polite" role="log">
      <div class="muted" id="loadingMsgs">Loading messages...</div>
    </div>

    <div class="inputBar" id="inputBar">
      <div class="input" style="position:relative">
        <button id="emojiBtn" title="Emoji" style="border:none;background:none"><i data-lucide="smile"></i></button>
        <input id="messageInput" placeholder="Type a message" autocomplete="off" inputmode="text" />
        <button id="attachBtn" title="Attach" style="border:none;background:none"><i data-lucide="paperclip"></i></button>

        <!-- emoji picker -->
        <div id="emojiPicker" class="emoji-picker" style="display:none" aria-hidden="true" role="dialog">
          <!-- sample emojis, you can expand or swap in a real emoji picker later -->
          üòÄ üòÅ üòÇ üòâ üòä üòç üòé üò¢ üò° üéâ üëç üôè ü§ù üíØ üî• ‚ú® üé∂ üéß
        </div>
      </div>
      <button id="sendBtn" class="btn" aria-label="Send message" disabled><i data-lucide="send"></i></button>
    </div>

  </div>

  <!-- profile modal -->
  <div id="profileModal" class="profile-modal" aria-hidden="true">
    <div class="profile-card">
      <div style="display:flex;gap:10px;align-items:center">
        <div style="width:68px;height:68px;border-radius:12px;background:#f6f6f6;overflow:hidden" id="pmPfp"><i data-lucide="user"></i></div>
        <div>
          <div id="pmName" style="font-weight:700"></div>
          <div id="pmUser" class="muted">@username</div>
        </div>
      </div>
      <div style="margin-top:12px">
        <div id="pmBio" style="color:#444"></div>
        <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
          <button id="closePM" class="btn" style="background:#fff;border:1px solid #eee;color:#111">Close</button>
          <button id="viewProfileBtn" class="btn" style="background:var(--orange);color:#fff">Open Profile</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Initialize icons once
    document.addEventListener("DOMContentLoaded", ()=> lucide.createIcons());

    // --- Viewport VH trick to avoid mobile chrome jump ---
    function setVhVar(){
      // 1vh unit equal to 1% of the viewport height
      document.documentElement.style.setProperty('--vh', (window.innerHeight * 0.01) + 'px');
    }
    setVhVar();
    window.addEventListener('resize', () => {
      setVhVar();
      // small debounce-like behavior
      clearTimeout(window.__rsz);
      window.__rsz = setTimeout(()=> {
        // ensure messages area stays scrolled to bottom when keyboard appears/disappears
        scrollToBottom({smooth:false});
      }, 120);
    });

    // DOM refs
    const messagesEl = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const emojiBtn = document.getElementById('emojiBtn');
    const emojiPicker = document.getElementById('emojiPicker');
    const attachBtn = document.getElementById('attachBtn');
    const openProfile = document.getElementById('openProfile');

    const profileModal = document.getElementById('profileModal');
    const pmPfp = document.getElementById('pmPfp');
    const pmName = document.getElementById('pmName');
    const pmUser = document.getElementById('pmUser');
    const pmBio = document.getElementById('pmBio');
    const closePM = document.getElementById('closePM');
    const viewProfileBtn = document.getElementById('viewProfileBtn');

    // Firebase (unchanged)
    const firebaseConfig = {
      apiKey: "AIzaSyCK4lJ_mjj5GNAruuIMxeiQprdB_vvcEP8",
      authDomain: "truesocial-94e80.firebaseapp.com",
      projectId: "truesocial-94e80",
      storageBucket: "truesocial-94e80.firebasestorage.app",
      messagingSenderId: "993255311929",
      appId: "1:993255311929:web:539d116fda9911960d5be8",
      measurementId: "G-Y2YQ6DJJGS"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // URL params
    const params = new URLSearchParams(location.search);
    let chatId = params.get('chatId');
    let otherUid = params.get('with');

    let currentUser = null;
    let otherUser = null;
    let messagesUnsub = null;

    // helper to format time (firestore timestamp safe)
    function formatTime(ts){
      if(!ts) return '';
      try {
        const d = (typeof ts.toDate === 'function') ? ts.toDate() : new Date(ts);
        return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      } catch(e){
        return '';
      }
    }

    function escapeHtml(s){ return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // robust scroll-to-bottom
    function scrollToBottom({smooth=true} = {}){
      try {
        if(smooth) messagesEl.scrollTo({top: messagesEl.scrollHeight, behavior:'smooth'});
        else messagesEl.scrollTop = messagesEl.scrollHeight;
      } catch(e) { messagesEl.scrollTop = messagesEl.scrollHeight; }
    }

    // ensure inputBar height is considered by messages area (in case of dynamic sizes)
    function adjustMessagesPadding(){
      const inputBar = document.getElementById('inputBar');
      const headerHeight = document.querySelector('header').offsetHeight || 64;
      const inputHeight = inputBar.offsetHeight || 72;
      messagesEl.style.paddingTop = (12 + headerHeight) + 'px';
      messagesEl.style.paddingBottom = (12 + inputHeight + parseInt(getComputedStyle(document.documentElement).getPropertyValue('--safe-bottom')) ) + 'px';
    }

    // Keep UI in sync when keyboard opens: scroll on focus
    messageInput.addEventListener('focus', ()=>{
      // hide emoji picker when focusing input
      hideEmojiPicker();
      setTimeout(()=> scrollToBottom({smooth:true}), 120);
    });

    // enable/disable send button
    messageInput.addEventListener('input', ()=> {
      sendBtn.disabled = messageInput.value.trim().length === 0;
    });

    // emoji picker toggling and insertion at cursor
    function showEmojiPicker(){
      emojiPicker.style.display = 'flex';
      emojiPicker.setAttribute('aria-hidden','false');
      // position above input properly (in case heights changed)
      const inputRect = messageInput.getBoundingClientRect();
      const picker = emojiPicker;
      // compute bottom offset so it appears just above the input
      picker.style.bottom = (window.innerHeight - inputRect.top + 8) + 'px'; // fallback; CSS already handles a decent default
    }
    function hideEmojiPicker(){
      emojiPicker.style.display = 'none';
      emojiPicker.setAttribute('aria-hidden','true');
    }
    emojiBtn.addEventListener('click', (e)=>{
      const visible = emojiPicker.style.display !== 'none';
      if(visible) hideEmojiPicker(); else { showEmojiPicker(); messageInput.focus(); }
    });

    // Insert emoji at cursor position
    emojiPicker.addEventListener('click', (e)=>{
      if(!e.target || !e.target.textContent) return;
      const emoji = e.target.textContent;
      // insert at caret in input
      const el = messageInput;
      const start = el.selectionStart || 0;
      const end = el.selectionEnd || 0;
      const value = el.value || '';
      el.value = value.slice(0,start) + emoji + value.slice(end);
      // set caret after inserted emoji
      const newPos = start + emoji.length;
      el.selectionStart = el.selectionEnd = newPos;
      el.focus();
      sendBtn.disabled = el.value.trim().length === 0;
    });

    // Attachment placeholder
    attachBtn.addEventListener('click', ()=>{ alert('Attachment not implemented in this MVP. Use Storage APIs to upload files.'); });

    // profile modal open
    openProfile.addEventListener('click', ()=>{
      profileModal.classList.add('open'); profileModal.setAttribute('aria-hidden','false');
      pmName.textContent = otherUser?.name || '';
      pmUser.textContent = '@' + (otherUser?.username||'');
      pmBio.textContent = otherUser?.bio || '';
      pmPfp.innerHTML = otherUser?.pfp ? `<img src="${otherUser.pfp}" style="width:100%;height:100%;object-fit:cover" />` : `<i data-lucide="user"></i>`;
      lucide.createIcons();
    });
    closePM.addEventListener('click', ()=>{ profileModal.classList.remove('open'); profileModal.setAttribute('aria-hidden','true'); });
    viewProfileBtn.addEventListener('click', ()=>{ location.href = 'profile.html?view=' + (otherUser?.uid || ''); });

    // Auto-init after auth
    auth.onAuthStateChanged(async user=>{
      if(!user) { location.href = 'login.html'; return; }
      currentUser = user;
      // find/create chat if necessary
      if(!chatId && otherUid){
        const q = await db.collection('chats').where('participants','array-contains', currentUser.uid).get();
        let found = null;
        q.forEach(d=>{
          const p = d.data().participants || [];
          if(p.includes(otherUid)) found = {id:d.id,data:d.data()};
        });
        if(found) chatId = found.id;
        else {
          const doc = await db.collection('chats').add({
            participants: [currentUser.uid, otherUid],
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
            lastMessage: null
          });
          chatId = doc.id;
        }
      }

      if(!chatId){
        messagesEl.innerHTML = '<div class="muted">No chat selected.</div>';
        return;
      }

      // infer otherUid from chat doc if missing
      if(!otherUid){
        const chatDoc = await db.collection('chats').doc(chatId).get();
        if(chatDoc.exists){
          const participants = chatDoc.data().participants || [];
          otherUid = participants.find(u=>u!==currentUser.uid);
        } else {
          messagesEl.innerHTML = '<div class="muted">Chat not found.</div>';
          return;
        }
      }

      // load other user data
      const otherDoc = await db.collection('users').doc(otherUid).get();
      otherUser = otherDoc.exists ? {...otherDoc.data(), uid: otherUid} : {name:'Unknown', username:'', pfp:''};
      document.getElementById('chatName').textContent = otherUser.name || 'Unknown';
      document.getElementById('chatStatus').textContent = otherUser.lastSeen ? 'Last seen: ' + (otherUser.lastSeen.toDate ? otherUser.lastSeen.toDate().toLocaleString() : otherUser.lastSeen) : 'Online';
      if(otherUser.pfp) document.getElementById('chatPfp').innerHTML = `<img src="${otherUser.pfp}" alt="">`;
      lucide.createIcons();

      // start listening for messages
      startMessagesListener();
      // ensure layout correct
      adjustMessagesPadding();
      setTimeout(()=> scrollToBottom({smooth:false}), 200);
    });

    // start listener
    function startMessagesListener(){
      if(messagesUnsub) messagesUnsub();
      messagesEl.innerHTML = '<div class="muted">Loading messages...</div>';
      const messagesRef = db.collection('chats').doc(chatId).collection('messages').orderBy('sentAt','asc');
      messagesUnsub = messagesRef.onSnapshot(snap=>{
        messagesEl.innerHTML = '';
        if(snap.empty){
          messagesEl.innerHTML = '<div class="muted">No messages yet. Say hi üëã</div>';
          return;
        }
        snap.forEach(doc=>{
          const m = doc.data();
          const divWrap = document.createElement('div');
          divWrap.style.display = 'flex';
          divWrap.style.flexDirection = 'column';
          divWrap.style.alignItems = (m.from === currentUser.uid) ? 'flex-end' : 'flex-start';

          const div = document.createElement('div');
          div.className = 'bubble ' + (m.from===currentUser.uid ? 'sent' : 'received');
          const safeText = escapeHtml(m.text || '');
          div.innerHTML = `<div class="message-text">${safeText}</div>
            <div class="metaSmall">${formatTime(m.sentAt || new Date())} <span class="tick ${m.read ? 'read' : ''}">${m.status==='read' ? '‚úì‚úì' : m.status==='delivered' ? '‚úì‚úì' : m.status==='sent' ? '‚úì' : ''}</span></div>`;
          divWrap.appendChild(div);
          messagesEl.appendChild(divWrap);
        });
        adjustMessagesPadding();
        // scroll to bottom after DOM update
        setTimeout(()=> scrollToBottom({smooth:true}), 80);
        lucide.createIcons();
      }, err=>{
        messagesEl.innerHTML = '<div class="muted">Could not load messages.</div>';
        console.error('messages error', err);
      });
    }

    // send message
    sendBtn.addEventListener('click', async ()=>{
      const text = messageInput.value.trim();
      if(!text) return;
      sendBtn.disabled = true;
      try{
        const msgRef = db.collection('chats').doc(chatId).collection('messages').doc();
        const msg = {
          id: msgRef.id,
          from: currentUser.uid,
          to: otherUid,
          text,
          sentAt: firebase.firestore.FieldValue.serverTimestamp(),
          status: 'sent', // sent -> delivered -> read
          read: false
        };
        await msgRef.set(msg);
        await db.collection('chats').doc(chatId).update({
          lastMessage: msg,
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });
        messageInput.value = '';
        sendBtn.disabled = true;
        // hide picker & re-focus
        hideEmojiPicker();
        messageInput.focus();
        // scroll after sending
        setTimeout(()=> scrollToBottom({smooth:true}), 120);
      } catch(err){
        alert('Message failed: ' + (err.message || err));
        console.error(err);
      } finally {
        sendBtn.disabled = false;
      }
    });

    // small accessibility: press Enter to send (without Shift)
    messageInput.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        if(!sendBtn.disabled) sendBtn.click();
      }
    });

    // Close emoji picker if clicking outside
    document.addEventListener('click', (e)=>{
      if(emojiPicker.contains(e.target) || emojiBtn.contains(e.target) || messageInput.contains(e.target)) return;
      hideEmojiPicker();
    });

    // initial adjust
    window.addEventListener('load', ()=> {
      adjustMessagesPadding();
      setTimeout(()=> scrollToBottom({smooth:false}), 200);
    });

    // ensure padding recalculated when styles/layout change (e.g., orientation)
    window.matchMedia("(orientation:portrait)").addEventListener('change', ()=> {
      adjustMessagesPadding();
      setTimeout(()=> scrollToBottom({smooth:false}), 140);
    });

    // Clean up subscription if page unloaded
    window.addEventListener('beforeunload', ()=>{
      if(messagesUnsub) messagesUnsub();
    });
  </script>

<!-- Lucide icons (proper global build) -->
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
</body>
</html>

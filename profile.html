<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>TrueSocial — Profile</title>

  <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/lucide.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <style>
    :root{--orange:#ff7a00;--bg:#fff;--muted:#666;--card-shadow:0 8px 22px rgba(0,0,0,0.06);--radius:14px;}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Roboto,Arial;background:#fff;color:#111;-webkit-font-smoothing:antialiased;}
    header.top{
      position:sticky;top:0;z-index:20;padding:12px 16px;background:linear-gradient(180deg,#fff,#fff);display:flex;align-items:center;gap:12px;border-bottom:1px solid #faf4f0;
    }
    .brand{display:flex;gap:8px;align-items:center;}
    .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--orange),#ff9a4d);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;}
    .pageTitle{font-size:16px;font-weight:700;}
    main{padding:18px;display:flex;flex-direction:column;gap:14px;}
    .card{background:white;border-radius:14px;padding:14px;box-shadow:var(--card-shadow);}
    .profile-row{display:flex;gap:12px;align-items:center;}
    .pfp{width:84px;height:84px;border-radius:18px;background:#f7f7f7;border:1px solid #fff;display:flex;align-items:center;justify-content:center;overflow:hidden;}
    .pfp img{width:100%;height:100%;object-fit:cover;}
    .info{flex:1;}
    .info h2{margin:0;font-size:18px;}
    .info p{margin:6px 0 0;color:var(--muted);font-size:13px}
    .edit-controls{display:flex;gap:8px;margin-top:8px;}
    input,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #f0f0f0;font-size:14px;}
    textarea{resize:none;}
    .btn{padding:10px 12px;border-radius:12px;border:none;}
    .btn.primary{background:linear-gradient(90deg,var(--orange),#ff944d);color:white;font-weight:700;box-shadow:0 8px 20px rgba(255,122,0,0.16)}
    .btn.ghost{background:#fff;border:1px solid #eee;}
    footer.bottom-nav{
      position:fixed;left:0;right:0;bottom:0;display:flex;justify-content:space-around;align-items:center;padding:10px 6px;background:linear-gradient(180deg,#fff,#fff);border-top:1px solid #f7f7f7;
      gap:6px;
    }
    .nav-item{display:flex;flex-direction:column;align-items:center;font-size:12px;color:#666;text-decoration:none;padding:6px;border-radius:12px;}
    .nav-item.active{color:var(--orange);background:linear-gradient(90deg,rgba(255,122,0,0.06),transparent);padding:8px;border-radius:12px;}
    .label{font-size:12px;margin-top:4px;}
    .small-muted{font-size:13px;color:var(--muted)}
    .progress{height:8px;background:#f3f3f3;border-radius:8px;overflow:hidden;margin-top:8px;}
    .progress .bar{height:100%;width:0;background:linear-gradient(90deg,var(--orange),#ff944d)}
    .top-actions{margin-left:auto;display:flex;gap:8px;align-items:center;}
    .logout{background:#fff;border:1px solid #f0f0f0;padding:8px;border-radius:10px;}
    /* landscape tweaks */
    @media (orientation:landscape){
      main{padding:16px;max-width:1100px;margin:0 auto;display:flex;gap:16px;}
      .left{flex:1}
      .right{flex:1}
      footer.bottom-nav{max-width:1100px;margin:0 auto;left:0;right:0}
    }
  </style>
</head>
<body>
  <header class="top">
    <div class="brand">
      <div class="logo">TS</div>
      <div>
        <div class="pageTitle">TrueSocial — Profile</div>
        <div class="small-muted">Edit your public profile</div>
      </div>
    </div>
    <div class="top-actions">
      <button id="editToggle" class="logout" title="Edit profile"><i data-lucide="edit-3"></i></button>
      <button id="logoutBtn" class="logout" title="Logout"><i data-lucide="log-out"></i></button>
    </div>
  </header>

  <main>
    <div class="card profile-row">
      <div class="pfp" id="pfpWrap" aria-hidden="false">
        <!-- pfp img goes here -->
        <img id="pfpImg" src="" alt="Profile picture" style="display:none"/>
        <div id="pfpPlaceholder" style="text-align:center;color:#bbb">No photo</div>
      </div>
      <div class="info">
        <h2 id="displayName">—</h2>
        <p id="displayUser" class="small-muted">@username</p>
        <p id="displayBio" class="small-muted">Your bio will appear here.</p>

        <div style="margin-top:10px;display:flex;gap:8px;">
          <label for="pfpFile" class="btn ghost" id="uploadLabel" style="cursor:pointer;"><i data-lucide="image"></i> Upload Photo</label>
          <input id="pfpFile" type="file" accept="image/*" style="display:none" />
          <button id="removePhoto" class="btn ghost">Remove</button>
        </div>

        <div class="progress" style="display:none" id="uploadProgress"><div class="bar" id="progressBar"></div></div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;gap:10px;align-items:center;">
        <div style="flex:1;">
          <label class="small-muted">Full name</label>
          <input id="nameInput" type="text" disabled />
        </div>
        <div style="width:120px">
          <label class="small-muted">Username</label>
          <input id="usernameInput" type="text" disabled />
        </div>
      </div>
      <div style="margin-top:10px;">
        <label class="small-muted">Bio</label>
        <textarea id="bioInput" rows="3" disabled></textarea>
      </div>
      <div style="display:flex;gap:8px;margin-top:12px;">
        <button id="saveBtn" class="btn primary" disabled>Save</button>
        <button id="cancelBtn" class="btn ghost" disabled>Cancel</button>
      </div>
      <div id="profileMsg" class="small-muted" style="margin-top:8px;"></div>
    </div>
  </main>

  <footer class="bottom-nav">
    <a class="nav-item" href="index.html"><i data-lucide="home"></i><span class="label">Chats</span></a>
    <a class="nav-item" href="search.html"><i data-lucide="search"></i><span class="label">Search</span></a>
    <a class="nav-item active" href="profile.html"><i data-lucide="user"></i><span class="label">Profile</span></a>
    <a class="nav-item" href="notifications.html"><i data-lucide="bell"></i><span class="label">Notifs</span></a>
  </footer>

  <script>
    // Initialize icons
    document.addEventListener("DOMContentLoaded", ()=> lucide.createIcons());

    // Firebase init
    const firebaseConfig = {
      apiKey: "AIzaSyCK4lJ_mjj5GNAruuIMxeiQprdB_vvcEP8",
      authDomain: "truesocial-94e80.firebaseapp.com",
      projectId: "truesocial-94e80",
      storageBucket: "truesocial-94e80.firebasestorage.app",
      messagingSenderId: "993255311929",
      appId: "1:993255311929:web:539d116fda9911960d5be8",
      measurementId: "G-Y2YQ6DJJGS"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // Elements
    const pfpImg = document.getElementById('pfpImg');
    const pfpPlaceholder = document.getElementById('pfpPlaceholder');
    const nameInput = document.getElementById('nameInput');
    const usernameInput = document.getElementById('usernameInput');
    const bioInput = document.getElementById('bioInput');
    const editToggle = document.getElementById('editToggle');
    const saveBtn = document.getElementById('saveBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const pfpFile = document.getElementById('pfpFile');
    const uploadProgress = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('progressBar');
    const uploadLabel = document.getElementById('uploadLabel');
    const removePhoto = document.getElementById('removePhoto');
    const profileMsg = document.getElementById('profileMsg');

    let currentUser = null;
    let userDocRef = null;
    let originalData = null;

    // Ensure user is logged in
    auth.onAuthStateChanged(async user => {
      if(!user){
        location.href = 'login.html'; return;
      }
      currentUser = user;
      userDocRef = db.collection('users').doc(user.uid);
      // Listen for realtime updates to user doc
      userDocRef.onSnapshot(doc => {
        if(!doc.exists) return;
        const data = doc.data();
        originalData = data;
        nameInput.value = data.name || '';
        usernameInput.value = data.username || '';
        bioInput.value = data.bio || '';
        document.getElementById('displayName').textContent = data.name || '—';
        document.getElementById('displayUser').textContent = '@' + (data.username || 'username');
        document.getElementById('displayBio').textContent = data.bio || '';
        if(data.pfp){
          pfpImg.src = data.pfp; pfpImg.style.display='block'; pfpPlaceholder.style.display='none';
        } else {
          pfpImg.style.display='none'; pfpPlaceholder.style.display='block';
        }
      }, err=>{
        console.error('User snapshot error',err);
      });
    });

    // Toggle edit mode
    let editing=false;
    editToggle.addEventListener('click', ()=> {
      editing=!editing;
      nameInput.disabled = !editing;
      usernameInput.disabled = !editing;
      bioInput.disabled = !editing;
      saveBtn.disabled = !editing;
      cancelBtn.disabled = !editing;
      if(editing){
        nameInput.focus();
        editToggle.innerHTML = '<i data-lucide="x"></i>'; lucide.createIcons();
      } else {
        editToggle.innerHTML = '<i data-lucide="edit-3"></i>'; lucide.createIcons();
        // revert to original if cancelled
        if(originalData){
          nameInput.value = originalData.name||'';
          usernameInput.value = originalData.username||'';
          bioInput.value = originalData.bio||'';
        }
      }
    });

    // Save profile changes (with unique username enforcement)
    saveBtn.addEventListener('click', async ()=>{
      profileMsg.textContent=''; saveBtn.disabled=true; saveBtn.textContent='Saving...';
      const newName = nameInput.value.trim();
      const newUser = usernameInput.value.trim().toLowerCase();
      const newBio = bioInput.value.trim();
      if(!newName || !newBio || !newUser){ profileMsg.textContent='Name, username and bio are required.'; saveBtn.disabled=false; saveBtn.textContent='Save'; return; }
      if(!/^[a-zA-Z0-9._]{3,30}$/.test(newUser)){ profileMsg.textContent='Invalid username. Use letters,numbers,._'; saveBtn.disabled=false; saveBtn.textContent='Save'; return; }
      try{
        // Check uniqueness if changed
        if(originalData && originalData.username !== newUser){
          const snap = await db.collection('users').where('username','==',newUser).get();
          if(!snap.empty){ throw new Error('Username already taken.'); }
        }
        await userDocRef.update({
          name: newName, username: newUser, bio: newBio, updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        profileMsg.textContent = 'Profile saved.'; editing=false;
        nameInput.disabled=true; usernameInput.disabled=true; bioInput.disabled=true; saveBtn.disabled=true; cancelBtn.disabled=true;
        editToggle.innerHTML = '<i data-lucide="edit-3"></i>'; lucide.createIcons();
      }catch(err){
        profileMsg.textContent = err.message || 'Save failed';
      }finally{ saveBtn.disabled=false; saveBtn.textContent='Save'; }
    });

    cancelBtn.addEventListener('click', ()=>{
      if(originalData){
        nameInput.value = originalData.name||'';
        usernameInput.value = originalData.username||'';
        bioInput.value = originalData.bio||'';
      }
      editing=false; nameInput.disabled=true; usernameInput.disabled=true; bioInput.disabled=true; saveBtn.disabled=true; cancelBtn.disabled=true;
      editToggle.innerHTML = '<i data-lucide="edit-3"></i>'; lucide.createIcons();
    });

    // Upload profile picture
    pfpFile.addEventListener('change', async (e)=>{
      const file = e.target.files[0];
      if(!file) return;
      // Simple validation
      if(!file.type.startsWith('image/')){ alert('Please choose an image file'); return; }
      const ext = file.name.split('.').pop();
      const path = `pfps/${currentUser.uid}_${Date.now()}.${ext}`;
      const ref = storage.ref().child(path);
      const uploadTask = ref.put(file);
      uploadProgress.style.display='block';
      uploadTask.on('state_changed', snapshot=>{
        const pct = Math.round((snapshot.bytesTransferred/snapshot.totalBytes)*100);
        progressBar.style.width = pct + '%';
      }, err=>{
        alert('Upload failed: ' + err.message);
        uploadProgress.style.display='none';
      }, async ()=>{
        const url = await ref.getDownloadURL();
        // update user doc with new pfp url
        await userDocRef.update({ pfp: url, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
        uploadProgress.style.display='none'; progressBar.style.width='0%';
      });
    });

    // Remove photo
    removePhoto.addEventListener('click', async ()=>{
      if(!confirm('Remove profile photo?')) return;
      try{
        await userDocRef.update({ pfp: '' });
      }catch(err){
        alert('Could not remove photo: ' + err.message);
      }
    });

    // Logout
    logoutBtn.addEventListener('click', async ()=>{
      await auth.signOut();
      location.href = 'login.html';
    });

    // Update lastSeen on unload
    window.addEventListener('beforeunload', ()=>{
      if(currentUser) db.collection('users').doc(currentUser.uid).update({ lastSeen: firebase.firestore.FieldValue.serverTimestamp() });
    });

  </script>
</body>
</html>

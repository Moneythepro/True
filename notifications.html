<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>TrueSocial â€” Notifications</title>

  <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/lucide.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <style>
    :root{--orange:#ff7a00;--muted:#666;}
    body{margin:0;font-family:Inter,system-ui,Roboto,Arial;background:white;color:#111}
    header{display:flex;align-items:center;gap:12px;padding:12px;border-bottom:1px solid #f7f7f7;position:sticky;top:0;background:white;z-index:20}
    .title{font-weight:700}
    main{padding:12px;padding-bottom:100px}
    .notif{background:white;padding:12px;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,0.04);margin-bottom:10px;display:flex;gap:12px;align-items:center;border:1px solid #fbf2ee}
    .muted{color:var(--muted)}
    .btn{padding:8px 10px;border-radius:10px;border:none}
    .primary{background:linear-gradient(90deg,var(--orange),#ff944d);color:white}
    .ghost{background:white;border:1px solid #eee}
    footer{position:fixed;left:0;right:0;bottom:0;padding:10px;background:white;border-top:1px solid #f7f7f7;display:flex;justify-content:space-around}
    .nav-item{display:flex;flex-direction:column;align-items:center;font-size:12px;color:#666;text-decoration:none;padding:6px;border-radius:12px;}
  </style>
</head>
<body>
  <header>
    <div class="title">Notifications</div>
    <div style="margin-left:auto"><button onclick="markAllRead()" class="btn ghost">Mark all read</button></div>
  </header>

  <main id="main">
    <div id="requestsSection">
      <div style="font-weight:700;margin-bottom:8px">Friend requests</div>
      <div id="requestsList" class="muted">Loading requests...</div>
    </div>

    <div style="margin-top:18px">
      <div style="font-weight:700;margin-bottom:8px">System notifications</div>
      <div id="systemList" class="muted">Loading notifications...</div>
    </div>
  </main>

  <footer>
    <a class="nav-item" href="index.html"><i data-lucide="message-square"></i><span class="label">Chats</span></a>
    <a class="nav-item" href="search.html"><i data-lucide="search"></i><span class="label">Search</span></a>
    <a class="nav-item" href="profile.html"><i data-lucide="user"></i><span class="label">Profile</span></a>
    <a class="nav-item active" href="notifications.html"><i data-lucide="bell"></i><span class="label">Notifs</span></a>
  </footer>

  <script>
    document.addEventListener("DOMContentLoaded", ()=> lucide.createIcons());
    const firebaseConfig = {
      apiKey: "AIzaSyCK4lJ_mjj5GNAruuIMxeiQprdB_vvcEP8",
      authDomain: "truesocial-94e80.firebaseapp.com",
      projectId: "truesocial-94e80",
      storageBucket: "truesocial-94e80.firebasestorage.app",
      messagingSenderId: "993255311929",
      appId: "1:993255311929:web:539d116fda9911960d5be8",
      measurementId: "G-Y2YQ6DJJGS"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    auth.onAuthStateChanged(u=>{
      if(!u) location.href='login.html';
      currentUser = u;
      listenRequests();
      listenSystem();
    });

    function listenRequests(){
      db.collection('friend_requests').where('to','==',currentUser.uid).onSnapshot(snap=>{
        const list = document.getElementById('requestsList');
        if(snap.empty){ list.innerHTML = '<div class="muted">No pending requests.</div>'; return; }
        list.innerHTML = '';
        snap.forEach(doc=>{
          const r = doc.data();
          const el = document.createElement('div'); el.className='notif';
          el.innerHTML = `
            <div style="flex:1">
              <div><strong>${r.fromName || r.from}</strong> <span class="muted">sent a friend request</span></div>
              <div class="muted" style="font-size:13px">${ r.createdAt ? new Date(r.createdAt.seconds*1000).toLocaleString() : '' }</div>
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn primary" data-id="${doc.id}" data-from="${r.from}">Accept</button>
              <button class="btn ghost" data-id="${doc.id}">Reject</button>
            </div>
          `;
          list.appendChild(el);
          // buttons
          el.querySelector('.primary').addEventListener('click', async (e)=>{
            const id = e.target.dataset.id;
            const from = e.target.dataset.from;
            // Add to friends list for both users (doc contains list array)
            const batch = db.batch();
            const meRef = db.collection('friends').doc(currentUser.uid);
            const otherRef = db.collection('friends').doc(from);
            try{
              await db.runTransaction(async tx => {
                const meDoc = await tx.get(meRef);
                const otherDoc = await tx.get(otherRef);
                const meList = meDoc.exists ? meDoc.data().list || [] : [];
                const otherList = otherDoc.exists ? otherDoc.data().list || [] : [];
                if(!meList.includes(from)) meList.push(from);
                if(!otherList.includes(currentUser.uid)) otherList.push(currentUser.uid);
                tx.set(meRef, { list: meList }, { merge:true });
                tx.set(otherRef, { list: otherList }, { merge:true });
                tx.update(db.collection('friend_requests').doc(id), { status:'accepted', respondedAt: firebase.firestore.FieldValue.serverTimestamp() });
                // create notification for other user
                tx.set(db.collection('notifications').doc(), { to: from, type:'friend_accepted', from: currentUser.uid, createdAt: firebase.firestore.FieldValue.serverTimestamp(), read:false });
              });
            }catch(err){ console.error('Accept failed',err); alert('Could not accept.'); }
          });
          el.querySelector('.ghost').addEventListener('click', async (e)=>{
            const id = e.target.dataset.id;
            try{ await db.collection('friend_requests').doc(id).update({ status:'rejected', respondedAt: firebase.firestore.FieldValue.serverTimestamp() }); }
            catch(err){ console.error(err); alert('Could not reject.'); }
          });
        });
      });
    }

    function listenSystem(){
      db.collection('notifications').where('to','==',currentUser.uid).orderBy('createdAt','desc').onSnapshot(snap=>{
        const list = document.getElementById('systemList');
        if(snap.empty){ list.innerHTML = '<div class="muted">No notifications.</div>'; return; }
        list.innerHTML = '';
        snap.forEach(doc=>{
          const n = doc.data();
          const el = document.createElement('div'); el.className='notif';
          el.innerHTML = `
            <div style="flex:1">
              <div>${n.type === 'friend_accepted' ? '<strong>Friend request accepted</strong>' : '<strong>System message</strong>'}</div>
              <div class="muted" style="font-size:13px">${n.message || (n.type === 'friend_accepted' ? 'Your request was accepted.' : '')}</div>
            </div>
            <div style="display:flex;gap:8px;flex-direction:column">
              <button class="btn ghost" data-id="${doc.id}">Mark read</button>
            </div>
          `;
          list.appendChild(el);
          el.querySelector('.ghost').addEventListener('click', async (e)=>{
            const id = e.target.dataset.id;
            try{ await db.collection('notifications').doc(id).update({ read:true }); } catch(err){ console.error(err); }
          });
        });
      });
    }

    async function markAllRead(){
      const snap = await db.collection('notifications').where('to','==',currentUser.uid).where('read','==',false).get();
      const batch = db.batch();
      snap.forEach(doc => batch.update(doc.ref, {read:true}));
      await batch.commit();
      alert('Marked all notifications as read.');
    }
  </script>
  <!-- Lucide Icons CDN -->
<script src="https://unpkg.com/lucide@latest"></script>
<script>
  lucide.createIcons(); // Initialize all Lucide icons
</script>
</body>
</html>

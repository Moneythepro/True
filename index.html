<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>TrueSocial â€” Chats</title>

  <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/lucide.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <style>
    :root{--orange:#ff7a00;--bg:#fff;--muted:#666;}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Roboto,Arial;background:linear-gradient(180deg,#fff,#fff);-webkit-font-smoothing:antialiased;color:#111}
    header.top{position:sticky;top:0;background:white;padding:12px 16px;display:flex;align-items:center;gap:12px;border-bottom:1px solid #faf4f4;z-index:20;}
    .logo{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(--orange),#ff9a4d);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;}
    .title{font-weight:700;font-size:16px;}
    .searchShort{margin-left:auto;background:#fff;border:1px solid #f0f0f0;padding:8px 10px;border-radius:12px;display:flex;gap:8px;align-items:center;color:#888;font-size:14px;cursor:pointer;}
    main{padding:12px;padding-bottom:84px;}
    .card{background:white;border-radius:12px;padding:10px;margin-bottom:10px;display:flex;gap:12px;align-items:center;box-shadow:0 6px 18px rgba(0,0,0,0.04);border:1px solid #fbf2ee;}
    .pfp{width:60px;height:60px;border-radius:12px;background:#f6f6f6;overflow:hidden;display:flex;align-items:center;justify-content:center;}
    .pfp img{width:100%;height:100%;object-fit:cover}
    .content{flex:1;display:flex;flex-direction:column}
    .nameRow{display:flex;justify-content:space-between;align-items:center}
    .name{font-weight:700;font-size:15px}
    .lastMsg{color:var(--muted);font-size:13px;margin-top:6px;display:flex;justify-content:space-between;align-items:center;gap:8px;}
    .badge{background:var(--orange);color:white;padding:4px 8px;border-radius:12px;font-size:12px;font-weight:700}
    .empty{padding:30px;text-align:center;color:#bbb;}
    footer.bottom-nav{position:fixed;left:0;right:0;bottom:0;display:flex;justify-content:space-around;align-items:center;padding:10px 6px;background:white;border-top:1px solid #f7f7f7;gap:6px;}
    .nav-item{display:flex;flex-direction:column;align-items:center;font-size:12px;color:#666;text-decoration:none;padding:6px;border-radius:12px;}
    .nav-item.active{color:var(--orange);background:linear-gradient(90deg,rgba(255,122,0,0.06),transparent);padding:8px;border-radius:12px;}
    .top-actions{display:flex;gap:8px;margin-left:auto}
    .muted{color:var(--muted)}
    /* skeleton */
    .skeleton{height:12px;background:#f6f6f6;border-radius:8px;animation:shimmer 1.2s infinite linear;}
    @keyframes shimmer{0%{opacity:1}50%{opacity:.4}100%{opacity:1}}
    @media (orientation:landscape){
      main{max-width:1100px;margin:0 auto}
    }
  </style>
</head>
<body>
  <header class="top">
    <div class="logo">TS</div>
    <div>
      <div class="title">TrueSocial</div>
      <div class="muted" style="font-size:12px">Chats</div>
    </div>
    <div class="searchShort" onclick="location.href='search.html'"><i data-lucide="search"></i> Search</div>
  </header>

  <main id="main">
    <div id="inbox" class="card" style="align-items:center;justify-content:space-between;">
      <div style="display:flex;gap:12px;align-items:center;">
        <i data-lucide="inbox" style="width:36px;height:36px;color:var(--orange)"></i>
        <div>
          <div style="font-weight:700">Inbox & Friend Requests</div>
          <div class="muted" style="font-size:13px">Tap to manage requests and notifications</div>
        </div>
      </div>
      <div>
        <button onclick="location.href='notifications.html'" class="btn" style="padding:8px 10px;border-radius:10px;border:1px solid #f0f0f0;background:#fff"><i data-lucide="bell"></i></button>
      </div>
    </div>

    <div id="chatsList">
      <!-- chat items get injected here -->
      <div class="empty" id="loadingChats">Loading chats...</div>
    </div>
  </main>

  <footer class="bottom-nav">
    <a class="nav-item active" href="index.html"><i data-lucide="message-square"></i><span class="label">Chats</span></a>
    <a class="nav-item" href="search.html"><i data-lucide="search"></i><span class="label">Search</span></a>
    <a class="nav-item" href="profile.html"><i data-lucide="user"></i><span class="label">Profile</span></a>
    <a class="nav-item" href="notifications.html"><i data-lucide="bell"></i><span class="label">Notifs</span></a>
  </footer>

  <script>
    document.addEventListener("DOMContentLoaded", ()=> lucide.createIcons());
    // Firebase init
    const firebaseConfig = {
      apiKey: "AIzaSyCK4lJ_mjj5GNAruuIMxeiQprdB_vvcEP8",
      authDomain: "truesocial-94e80.firebaseapp.com",
      projectId: "truesocial-94e80",
      storageBucket: "truesocial-94e80.firebasestorage.app",
      messagingSenderId: "993255311929",
      appId: "1:993255311929:web:539d116fda9911960d5be8",
      measurementId: "G-Y2YQ6DJJGS"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const main = document.getElementById('main');
    const chatsList = document.getElementById('chatsList');
    const loadingChats = document.getElementById('loadingChats');

    let currentUser = null;
    // Listen for login and redirect if not
    auth.onAuthStateChanged(user=>{
      if(!user) location.href = 'login.html';
      currentUser = user;
      setupChatListener();
    });

    // Helper to create chat item
    function renderChatItem(chatId, chatData, otherUser, lastMessage, unreadCount){
      const div = document.createElement('div');
      div.className = 'card';
      div.onclick = () => { location.href = `chat.html?chatId=${chatId}&with=${otherUser.uid}`; };
      div.innerHTML = `
        <div class="pfp">${ otherUser.pfp ? `<img src="${otherUser.pfp}" alt="">` : `<i data-lucide="user"></i>` }</div>
        <div class="content">
          <div class="nameRow">
            <div class="name">${otherUser.name}</div>
            <div style="font-size:12px;color:#999">${ lastMessage ? timeAgo(lastMessage.sentAt) : '' }</div>
          </div>
          <div class="lastMsg">
            <div style="flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${ lastMessage ? (lastMessage.text||'ðŸ“Ž Attachment') : 'No messages yet' }</div>
            ${ unreadCount>0 ? `<div class="badge">${unreadCount}</div>` : '' }
          </div>
        </div>
      `;
      lucide.createIcons();
      return div;
    }

    // Real-time listener for chats collection (where participants array contains current uid)
    let unsubscribeChats = null;
    function setupChatListener(){
      if(unsubscribeChats) unsubscribeChats();
      unsubscribeChats = db.collection('chats').where('participants','array-contains', currentUser.uid)
        .orderBy('lastUpdated','desc')
        .onSnapshot(async snap=>{
          if(snap.empty){ chatsList.innerHTML = `<div class="empty">No chats yet. Search people to start a conversation.</div>`; return; }
          chatsList.innerHTML = '';
          const batch = [];
          snap.forEach(doc => batch.push({id:doc.id, data:doc.data()}));
          // For each chat, fetch other user's info and last message + unread count
          for(const chat of batch){
            const participants = chat.data.participants || [];
            const otherUid = participants.find(u=>u!==currentUser.uid);
            // fetch other user doc
            const userDoc = await db.collection('users').doc(otherUid).get();
            const otherUser = userDoc.exists ? {...userDoc.data(), uid: otherUid} : {name:'Unknown', pfp:'', uid:otherUid};
            // get last message (client may keep lastMessage field in chat doc)
            const lastMessage = chat.data.lastMessage || null;
            // unread count: count messages in chat/messages where to==currentUser && read==false
            const unreadSnap = await db.collection('chats').doc(chat.id).collection('messages')
              .where('to','==',currentUser.uid).where('read','==',false).get();
            const unreadCount = unreadSnap.size;
            const el = renderChatItem(chat.id, chat.data, otherUser, lastMessage, unreadCount);
            chatsList.appendChild(el);
          }
        }, err=>{
          console.error('Chat listener error', err);
          chatsList.innerHTML = `<div class="empty">Could not load chats (network).</div>`;
        });
    }

    // Utility: human-friendly time
    function timeAgo(ts){
      if(!ts) return '';
      let date = ts.toDate ? ts.toDate() : new Date(ts);
      const diff = Math.floor((Date.now()-date.getTime())/1000);
      if(diff < 60) return `${diff}s`;
      if(diff < 3600) return `${Math.floor(diff/60)}m`;
      if(diff < 86400) return `${Math.floor(diff/3600)}h`;
      return date.toLocaleDateString();
    }
  </script>
</body>
</html>
